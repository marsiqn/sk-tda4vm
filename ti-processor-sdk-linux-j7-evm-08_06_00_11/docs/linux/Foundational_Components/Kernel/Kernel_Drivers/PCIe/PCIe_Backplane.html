

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.2.2.12. PCIe Backplane &mdash; Processor SDK Linux for J721e Documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../../../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../../../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../../search.html"/>
    <link rel="top" title="Processor SDK Linux for J721e Documentation" href="../../../../../index.html"/>
        <link rel="up" title="3.2.2. Kernel Drivers" href="../../../../Foundational_Components_Kernel_Drivers.html"/>
        <link rel="next" title="3.2.2.13. PCIe Root Complex" href="PCIe_Root_Complex.html"/>
        <link rel="prev" title="3.2.2.11. PCIe End Point" href="PCIe_End_Point.html"/> 

  
  <script src="../../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">
  <header id="tiHeader">
    <div class="top">
      <ul>
        <li id="top_logo">
          <a href="http://www.ti.com">
            <img src="../../../../../_static/img/ti_logo.png"/>
          </a>
        </li>
      </ul>
    </div>
    <div class="nav"></div>
  </header>
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../../devices/J7/linux/index.html" class="icon icon-home"> Processor SDK Linux for J721e
          

          
          </a>

          
            
            
              <div class="version">
                08_06_00
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../Overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../devices/J7/linux/Release_Specific.html">2. Release Specific</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../Foundational_Components.html">3. Foundational Components</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_U-Boot.html">3.1. U-Boot</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../../Foundational_Components_Kernel.html">3.2. Kernel</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../../../Foundational_Components_Kernel_Users_Guide.html">3.2.1. Users Guide</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../../../Foundational_Components_Kernel_Drivers.html">3.2.2. Kernel Drivers</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../ADC.html">3.2.2.1. ADC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Audio.html">3.2.2.2. Audio</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Camera/CSI2RX.html">3.2.2.3. CSI2RX</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Crypto.html">3.2.2.4. Crypto</a></li>
<li class="toctree-l4"><a class="reference internal" href="../MCAN.html">3.2.2.5. MCAN</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Display/DSS7.html">3.2.2.6. DSS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../GPIO.html">3.2.2.7. GPIO</a></li>
<li class="toctree-l4"><a class="reference internal" href="../HYPERFLASH.html">3.2.2.8. HyperBus and HyperFlash</a></li>
<li class="toctree-l4"><a class="reference internal" href="../I2C.html">3.2.2.9. I2C</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Network/CPSW-Ethernet.html">3.2.2.10. CPSW Ethernet</a></li>
<li class="toctree-l4"><a class="reference internal" href="PCIe_End_Point.html">3.2.2.11. PCIe End Point</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">3.2.2.12. PCIe Backplane</a></li>
<li class="toctree-l4"><a class="reference internal" href="PCIe_Root_Complex.html">3.2.2.13. PCIe Root Complex</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../Foundational_Components_Kernel_Drivers_Power_Management.html">3.2.2.14. Power Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="../QSPI.html">3.2.2.15. OSPI/QSPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="../SERDES/SERDES.html">3.2.2.16. SERDES</a></li>
<li class="toctree-l4"><a class="reference internal" href="../SPI.html">3.2.2.17. SPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Storage/NAND.html">3.2.2.18. NAND</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Storage/MMC-SD.html">3.2.2.19. MMC/SD</a></li>
<li class="toctree-l4"><a class="reference internal" href="../UART.html">3.2.2.20. UART</a></li>
<li class="toctree-l4"><a class="reference internal" href="../UFS.html">3.2.2.21. UFS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../USB/CDNS3.html">3.2.2.22. USB</a></li>
<li class="toctree-l4"><a class="reference internal" href="../VTM.html">3.2.2.23. Voltage &amp; Thermal Management (VTM)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../Foundational_Components_Kernel_LTP-DDT_Validation.html">3.2.3. LTP-DDT Validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../Foundational_Components_Kernel_FAQs.html">3.2.4. FAQs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Filesystem.html">3.3. Filesystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Tools.html">3.4. Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_IPCLLD.html">3.5. IPC Low Level Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Graphics.html">3.6. Graphics and Display</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Multimedia_D5520_VXE384.html">3.7. Multimedia Video Codec</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Virtualization.html">3.8. Virtualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_ATF.html">3.9. ARM Trusted Firmware-A</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_OPTEE.html">3.10. OP-TEE</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../How_to_Guides.html">4. How to Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Documentation_Tarball.html">5. Documentation Tarball</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../../devices/J7/linux/index.html">Processor SDK Linux for J721e</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../../devices/J7/linux/index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../../Foundational_Components.html">3. Foundational Components</a> &raquo;</li>
      
          <li><a href="../../../../Foundational_Components_Kernel.html">3.2. Kernel</a> &raquo;</li>
      
          <li><a href="../../../../Foundational_Components_Kernel_Drivers.html">3.2.2. Kernel Drivers</a> &raquo;</li>
      
    <li>3.2.2.12. PCIe Backplane</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="pcie-backplane">
<h1>3.2.2.12. PCIe Backplane<a class="headerlink" href="#pcie-backplane" title="Permalink to this headline">Â¶</a></h1>
<p class="rubric" id="introduction-linux-pcie-backplane"><strong>Introduction</strong></p>
<p>PCIe backplane allows multiple hosts with RC ports to communicate and share
data with each other.</p>
<img alt="../../../../../_images/j7-linux-pcie-backplane.png" src="../../../../../_images/j7-linux-pcie-backplane.png" />
<p>PCIe backplane is implemented using multiple instances of multi-function
endpoint controller. Each host should be connected to a separate endpoint
controller instance and each host will enumerate the other host as an
independent function.</p>
<p>PCIe uses NTB (non transparent bridge) for two hosts to communicate with each
other. Though J721E doesnât have an explicit NTB controller, NTB functionality
can be achieved using multiple endpoint controller instances. And for PCIe
backplane (to connect more than 2 hosts), aggregation of NTB controllers
can be modeled using multiple instances of multi-function endpoint controller.</p>
<p>In the below diagram, PCI NTB function configures the SoC with multiple
PCIe Endpoint (EP) instances in such a way that transaction from one EP
controller is routed to the other EP controller. Once PCI NTB function
configures the SoC with multiple EP instances, HOST1 and HOST2 can
communicate with each other using SoC as a bridge.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>   +-------------+                                   +-------------+
   |             |                                   |             |
   |    HOST1    |                                   |    HOST2    |
   |             |                                   |             |
   +------^------+                                   +------^------+
          |                                                 |
          |                                                 |
+---------|-------------------------------------------------|---------+
|  +------v------+                                   +------v------+  |
|  |             |                                   |             |  |
|  |     EP      |                                   |     EP      |  |
|  | CONTROLLER1 |                                   | CONTROLLER2 |  |
|  |             &lt;-----------------------------------&gt;             |  |
|  |             |                                   |             |  |
|  |             |                                   |             |  |
|  |             |  SoC With Multiple EP Instances   |             |  |
|  |             |  (Configured using NTB Function)  |             |  |
|  +-------------+                                   +-------------+  |
+---------------------------------------------------------------------+
</pre></div>
</div>
<p class="rubric" id="ntb-sw-architecture"><strong>NTB SW Architecture</strong></p>
<p>The SW architecture for NTB both on the host side and EP side is given
below. The top half is the host side NTB architecture, and the bottom half is
the endpoint side NTB architecture.</p>
<img alt="../../../../../_images/ntb_sw_architecture.png" src="../../../../../_images/ntb_sw_architecture.png" />
<p class="rubric" id="backplane-setup"><strong>Backplane Setup</strong></p>
<p>The following picture shows J721E EVM connected to two DRA7 EVMs. Here the two
DRA7x boards communicate with each other using J721E as backplane.</p>
<img alt="../../../../../_images/j7-backplane.jpg" src="../../../../../_images/j7-backplane.jpg" />
<p class="rubric" id="backplane-configuration"><strong>Backplane Configuration</strong></p>
<p class="rubric" id="id1"><em>Backplane DTS Overlay File</em></p>
<p>The following DTS overlay file configures the PCIe controller in EP mode and
also contains a device tree node to create a NTB function device:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>arch/arm64/boot/dts/ti/k3-j721e-pcie-backplane.dtso
</pre></div>
</div>
<p>In order to apply the dts overlay file, the following command should be given
in u-boot prompt:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>#setenv name_overlays k3-j721e-pcie-backplane.dtbo
</pre></div>
</div>
<p class="rubric" id="ep-side-configuration"><em>EP Side Configuration (J721E Backplane)</em></p>
<p class="rubric"><strong>Dip switch settings</strong></p>
<p>Both PCIe instances should be configured in EP mode by setting
PCIE_1L_MODE_SEL (switch 5) and PCIE_2L_MODE_SEL (switch 6) in sw3 to â1â.</p>
<p class="rubric"><strong>8.x SDK (5.10 Kernel)</strong></p>
<p>The following set of steps is required only for 5.10 Kernel</p>
<blockquote>
<div><p class="rubric">Creating pci-epf-ntb device</p>
<p>PCI endpoint function device can be created using the configfs. To
create pci-epf-ntb device, the following commands can be used:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># mount -t configfs none /sys/kernel/config
# cd /sys/kernel/config/pci_ep/
# mkdir functions/pci_epf_ntb/func1
</pre></div>
</div>
<p>The âmkdir func1â above creates the pci-epf-ntb function device that will
be probed by pci_epf_ntb driver.</p>
<p>The PCI endpoint framework populates the directory with the following
configurable fields</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ls functions/pci_epf_ntb/func1
baseclass_code    deviceid          msi_interrupts    pci-epf-ntb.0
progif_code       secondary         subsys_id         vendorid
cache_line_size   interrupt_pin     msix_interrupts   primary
revid             subclass_code     subsys_vendor_id
</pre></div>
</div>
<p>The PCI endpoint function driver populates these entries with default values
when the device is bound to the driver. The pci-epf-ntb driver populates
vendorid with 0xffff and interrupt_pin with 0x0001</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># cat functions/pci_epf_ntb/func1/vendorid
0xffff
# cat functions/pci_epf_ntb/func1/interrupt_pin
0x0001
</pre></div>
</div>
<p class="rubric">Configuring pci-epf-ntb Device</p>
<p>The user can configure the pci-epf-ntb device using its configfs entry. In order
to change the vendorid and the deviceid, the following
commands can be used</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># echo 0x104c &gt; functions/pci_epf_ntb/func1/vendorid
# echo 0xb00d &gt; functions/pci_epf_ntb/func1/deviceid
</pre></div>
</div>
<p>In order to configure NTB specific attributes, a new sub-directory to func1
should be created</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># mkdir functions/pci_epf_ntb/func1/pci_epf_ntb.0/
</pre></div>
</div>
<p>The NTB function driver will populate this directory with various attributes
that can be configured by the user</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ls functions/pci_epf_ntb/func1/pci_epf_ntb.0/
db_count    mw1         mw2         mw3         mw4         num_mws
spad_count
</pre></div>
</div>
<p>A sample configuration for NTB function is given below</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># echo 4 &gt; functions/pci_epf_ntb/func1/pci_epf_ntb.0/db_count
# echo 128 &gt; functions/pci_epf_ntb/func1/pci_epf_ntb.0/spad_count
# echo 2 &gt; functions/pci_epf_ntb/func1/pci_epf_ntb.0/num_mws
# echo 0x100000 &gt; functions/pci_epf_ntb/func1/pci_epf_ntb.0/mw1
# echo 0x100000 &gt; functions/pci_epf_ntb/func1/pci_epf_ntb.0/mw2
</pre></div>
</div>
<p class="rubric">Binding pci-epf-ntb Device to EP Controller</p>
<p>NTB function device should be attached to two PCI endpoint controllers
connected to the two hosts. Use the âprimaryâ and âsecondaryâ entries
inside NTB function device to attach one PCI endpoint controller to
primary interface and the other PCI endpoint controller to the secondary
interface</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ln -s controllers/2900000.pcie-ep/ functions/pci-epf-ntb/func1/primary
# ln -s controllers/2910000.pcie-ep/ functions/pci-epf-ntb/func1/secondary
</pre></div>
</div>
<p>Once the above step is completed, both the PCI endpoint controllers are ready to
establish a link with the host.</p>
<p class="rubric">Start the Link: 7.x and 8.x SDK (5.4 and 5.10 Kernel)</p>
<p>In order for the endpoint device to establish a link with the host, the _start_
field should be populated with â1â. For NTB, both the PCI endpoint controllers
should establish link with the host</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># echo 1 &gt; controllers/2900000.pcie-ep/start
# echo 1 &gt; controllers/2910000.pcie-ep/start
</pre></div>
</div>
</div></blockquote>
<p>(PCIe2 can also be configured for NTB, but that is not
tested yet).</p>
<p class="rubric" id="rc-side-configuration"><em>RC Side Configuration</em></p>
<p>The hosts that have to communicate with each other can be bought up in any order
after EP has been brought up. Once the host boots up, the below steps have
to be done in each of the hosts.</p>
<p>Since the same vendor ID and device ID are used for multiple function drivers
(pci-endpoint-test and ntb_hw_epf), the device should be first ubound from
existing driver.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>echo 0000:01:00.0 &gt; /sys/bus/pci/devices/0000\:01\:00.0/driver/unbind
</pre></div>
</div>
<p>After unbinding from existing driver, it should be bound to ntb_hw_epf driver.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>echo 0000:01:00.0 &gt; /sys/bus/pci/drivers/ntb_hw_epf/bind
</pre></div>
</div>
<p>Then bind one of the NTB application driver. Here ntb_netdev is bound to emulate
ethernet over PCIe. This will create a new ethernet interface for each of the
hosts.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>modprobe ntb_transport
modprobe ntb_netdev
</pre></div>
</div>
<p class="rubric" id="kernel-configs"><strong>Kernel Configs</strong></p>
<p class="rubric" id="ep-side-configs"><em>EP Side (J721E Backplane)</em></p>
<div class="highlight-text"><div class="highlight"><pre><span></span>CONFIG_PCI_ENDPOINT=y
CONFIG_PCI_ENDPOINT_CONFIGFS=y
CONFIG_PCI_EPF_NTB=y
CONFIG_PCI_J721E=y
CONFIG_PCIE_CADENCE=y
CONFIG_PCIE_CADENCE_EP=y
</pre></div>
</div>
<p class="rubric" id="rc-side-configs"><em>Host Side</em></p>
<div class="highlight-text"><div class="highlight"><pre><span></span>CONFIG_PCI=y
CONFIG_PCI_MSI=y
CONFIG_NTB=m
CONFIG_NTB_EPF=m
CONFIG_NTB_TRANSPORT=m
CONFIG_NTB_NETDEV=m
RC controller configs
</pre></div>
</div>
<p class="rubric" id="additional-information"><strong>Additional Information</strong></p>
<p>For additional information, please refer to:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>&lt;Processor_SDK_install_dir&gt;/board-support/linux-[ver]/Documentation/PCI/endpoint/pci-test-ntb.txt
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="PCIe_Root_Complex.html" class="btn btn-neutral float-right" title="3.2.2.13. PCIe Root Complex" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="PCIe_End_Point.html" class="btn btn-neutral" title="3.2.2.11. PCIe End Point" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
      <a href="http://www.ti.com/corp/docs/legal/copyright.shtml">&copy; Copyright 1995-2021</a>, Texas Instruments Incorporated. All rights reserved. <br>
      <a href="http://www.ti.com/corp/docs/legal/trademark/trademrk.htm">Trademarks</a> | <a href="http://www.ti.com/corp/docs/legal/privacy.shtml">Privacy policy</a> | <a href="http://www.ti.com/corp/docs/legal/termsofuse.shtml">Terms of use</a> | <a href="http://www.ti.com/lsds/ti/legal/termsofsale.page">Terms of sale</a>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../../',
            VERSION:'08_06_00',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>

  

  
  
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
        });

      var menuHeight = window.innerHeight;

      var contentOffset = $(".wy-nav-content-wrap").offset();
      var contentHeight = $(".wy-nav-content-wrap").height();
      var contentBottom = contentOffset.top + contentHeight;

      function setNavbarTop() {
          var scrollTop = $(window).scrollTop();
          var maxTop = scrollTop + menuHeight;

          // If past the header
          if (scrollTop > contentOffset.top && maxTop < contentBottom) {
            stickyTop = scrollTop - contentOffset.top;
          } else if (maxTop > contentBottom) {
            stickyTop = scrollTop - contentOffset.top - (maxTop - contentBottom);
          } else {
            stickyTop = 0;
          }

          $(".wy-nav-side").css("top", stickyTop);
      }

      $(document).ready(function() {
        setNavbarTop();
        $(window).scroll(function () {
          setNavbarTop();
        });
      });
  </script>
   

</body>
</html>


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.2.2.10.3.3.2.3. CBS &mdash; Processor SDK Linux for J721e Documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../../../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../../../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../../search.html"/>
    <link rel="top" title="Processor SDK Linux for J721e Documentation" href="../../../../../index.html"/>
        <link rel="up" title="3.2.2.10.3.3. TSN with CPSW" href="CPSW-TSN.html"/>
        <link rel="next" title="3.2.2.10.3.3.2.4. IET" href="CPSW-IET.html"/>
        <link rel="prev" title="3.2.2.10.3.3.2.2. EST" href="CPSW-EST.html"/> 

  
  <script src="../../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">
  <header id="tiHeader">
    <div class="top">
      <ul>
        <li id="top_logo">
          <a href="http://www.ti.com">
            <img src="../../../../../_static/img/ti_logo.png"/>
          </a>
        </li>
      </ul>
    </div>
    <div class="nav"></div>
  </header>
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../../devices/J7/linux/index.html" class="icon icon-home"> Processor SDK Linux for J721e
          

          
          </a>

          
            
            
              <div class="version">
                08_06_00
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../Overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../devices/J7/linux/Release_Specific.html">2. Release Specific</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../Foundational_Components.html">3. Foundational Components</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_U-Boot.html">3.1. U-Boot</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../../Foundational_Components_Kernel.html">3.2. Kernel</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../../../Foundational_Components_Kernel_Users_Guide.html">3.2.1. Users Guide</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../../../Foundational_Components_Kernel_Drivers.html">3.2.2. Kernel Drivers</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../ADC.html">3.2.2.1. ADC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Audio.html">3.2.2.2. Audio</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Camera/CSI2RX.html">3.2.2.3. CSI2RX</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Crypto.html">3.2.2.4. Crypto</a></li>
<li class="toctree-l4"><a class="reference internal" href="../MCAN.html">3.2.2.5. MCAN</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Display/DSS7.html">3.2.2.6. DSS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../GPIO.html">3.2.2.7. GPIO</a></li>
<li class="toctree-l4"><a class="reference internal" href="../HYPERFLASH.html">3.2.2.8. HyperBus and HyperFlash</a></li>
<li class="toctree-l4"><a class="reference internal" href="../I2C.html">3.2.2.9. I2C</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="CPSW-Ethernet.html">3.2.2.10. CPSW Ethernet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../PCIe/PCIe_End_Point.html">3.2.2.11. PCIe End Point</a></li>
<li class="toctree-l4"><a class="reference internal" href="../PCIe/PCIe_Backplane.html">3.2.2.12. PCIe Backplane</a></li>
<li class="toctree-l4"><a class="reference internal" href="../PCIe/PCIe_Root_Complex.html">3.2.2.13. PCIe Root Complex</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../Foundational_Components_Kernel_Drivers_Power_Management.html">3.2.2.14. Power Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="../QSPI.html">3.2.2.15. OSPI/QSPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="../SERDES/SERDES.html">3.2.2.16. SERDES</a></li>
<li class="toctree-l4"><a class="reference internal" href="../SPI.html">3.2.2.17. SPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Storage/NAND.html">3.2.2.18. NAND</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Storage/MMC-SD.html">3.2.2.19. MMC/SD</a></li>
<li class="toctree-l4"><a class="reference internal" href="../UART.html">3.2.2.20. UART</a></li>
<li class="toctree-l4"><a class="reference internal" href="../UFS.html">3.2.2.21. UFS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../USB/CDNS3.html">3.2.2.22. USB</a></li>
<li class="toctree-l4"><a class="reference internal" href="../VTM.html">3.2.2.23. Voltage &amp; Thermal Management (VTM)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../Foundational_Components_Kernel_LTP-DDT_Validation.html">3.2.3. LTP-DDT Validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../Foundational_Components_Kernel_FAQs.html">3.2.4. FAQs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Filesystem.html">3.3. Filesystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Tools.html">3.4. Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_IPCLLD.html">3.5. IPC Low Level Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Graphics.html">3.6. Graphics and Display</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Multimedia_D5520_VXE384.html">3.7. Multimedia Video Codec</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Virtualization.html">3.8. Virtualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_ATF.html">3.9. ARM Trusted Firmware-A</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_OPTEE.html">3.10. OP-TEE</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../How_to_Guides.html">4. How to Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Documentation_Tarball.html">5. Documentation Tarball</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../../devices/J7/linux/index.html">Processor SDK Linux for J721e</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../../devices/J7/linux/index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../../Foundational_Components.html">3. Foundational Components</a> &raquo;</li>
      
          <li><a href="../../../../Foundational_Components_Kernel.html">3.2. Kernel</a> &raquo;</li>
      
          <li><a href="../../../../Foundational_Components_Kernel_Drivers.html">3.2.2. Kernel Drivers</a> &raquo;</li>
      
          <li><a href="CPSW-Ethernet.html">3.2.2.10. CPSW Ethernet</a> &raquo;</li>
      
          <li><a href="CPSW-TSN.html">3.2.2.10.3.3. TSN with CPSW</a> &raquo;</li>
      
    <li>3.2.2.10.3.3.2.3. CBS</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="cbs">
<h1>3.2.2.10.3.3.2.3. CBS<a class="headerlink" href="#cbs" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a><ul>
<li><a class="reference internal" href="#host-port-ingress-rate-limiting-offload" id="id2">Host port ingress Rate Limiting offload</a></li>
<li><a class="reference internal" href="#switch-egress-ethernet-port-transmit-rate-limiting-offload" id="id3">Switch egress, Ethernet Port Transmit Rate Limiting offload</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cbs-in-mac-mode" id="id4">CBS in MAC mode</a><ul>
<li><a class="reference internal" href="#rate-limiting-host-port-ingress-on-am625-sk" id="id5">Rate-limiting Host Port Ingress on AM625-SK</a></li>
<li><a class="reference internal" href="#rate-limiting-host-port-ingress-on-j7vcl" id="id6">Rate-limiting Host Port Ingress on J7VCL</a></li>
<li><a class="reference internal" href="#rate-limiting-switch-egress-on-am625-sk-data-sent-from-host-port-of-am625-sk-to-j7vcl" id="id7">Rate-limiting Switch Egress on AM625-SK (Data sent from Host Port of AM625-SK to J7VCL)</a></li>
<li><a class="reference internal" href="#rate-limiting-switch-egress-on-j7vcl-data-sent-from-host-port-of-j7vcl-to-am625-sk" id="id8">Rate-limiting Switch Egress on J7VCL (Data sent from Host Port of J7VCL to AM625-SK)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cbs-in-switch-mode" id="id9">CBS in Switch mode</a><ul>
<li><a class="reference internal" href="#rate-limiting-switch-egress-on-am625-sk-data-sent-from-am64-sk-to-j7vcl-via-am625-sk-switch" id="id10">Rate limiting Switch Egress on AM625-SK (Data sent from AM64-SK to J7VCL via AM625-SK switch)</a></li>
<li><a class="reference internal" href="#rate-limiting-switch-egress-on-j7vcl-data-sent-from-am64-sk-to-am625-sk-via-j7vcl-switch" id="id11">Rate-limiting Switch Egress on J7VCL (Data sent from AM64-SK to AM625-SK via J7VCL switch)</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">3.2.2.10.3.3.2.3.1. Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The K3 CPSW HW supports 2 level of traffic 802.1Qav shapers which are bound to TX DMA channels on Host Port and External Ports FIFOs which represent HW traffic
classes. The HW shapers allows to configure Committed Information Rate (guaranteed) and Excess Information Rate (non guaranteed) per TX DMA channels or External Ports Fifos.</p>
<p>The CPSWxG driver allows to perform Traffic Rate Limiting/shaping at:</p>
<ul class="simple">
<li>Host port ingress Rate Limiting, by configuring per TX DMA channels shaper. Only committed information rate is supported.</li>
<li>Switch egress, Ethernet Port Transmit Rate Limiting, by configuring per TX FIFO shaper. Both committed and excess information rate is supported.</li>
</ul>
<p>The number of Host port TX DMA channels is configurable (up to 8) through ethtool commands:- -L.
The Host port TX DMA channels processing mode has to be switched in Fixed priority mode through ethtool commands: –set-priv-flags.
Also note that –set-priv-flags and -L ethtool commands can be execute only when all Ethernet interfaces are down.</p>
<p>The Linux TC MQPRIO Qdisc can be used for mapping of packet priorities to traffic classes and routing packets to dedicated TX DMA channels or External Ports FIFOs.</p>
<div class="section" id="host-port-ingress-rate-limiting-offload">
<h3><a class="toc-backref" href="#id2">3.2.2.10.3.3.2.3.1.1. Host port ingress Rate Limiting offload</a><a class="headerlink" href="#host-port-ingress-rate-limiting-offload" title="Permalink to this headline">¶</a></h3>
<p>The netdev sysfs <strong>tx_maxrate</strong> parameter can be used to configure rate limit in Mbit/s per TX DMA channel.
The rate for shapers has to be set a little bit more then potential incoming rate, and real rates can differ, due to discreetness.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>echo 100 &gt; /sys/class/net/eth2/queues/tx-7/tx_maxrate
</pre></div>
</div>
<p class="rubric">Host port ingress Rate Limiting offload example</p>
<p>In this example Rate Limiting is enabled only for Host port TX channels.</p>
<ul class="simple">
<li>tc filters are used to assign pri for iperf3 traffic using port as filter value</li>
<li>pri7 traffic routed to TX DMA channel 7, rate limit 100Mbit</li>
<li>pri6 traffic routed to TX DMA channel 6, rate limit 200Mbit</li>
<li>pri0-5 traffic routed to TX DMA channel 0</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span>ip link set dev eth0 down
ethtool -L eth0 tx 8
ip link set dev eth0 up

tc qdisc replace dev eth0 handle 100: parent root mqprio num_tc 3 \
map 0 0 0 0 0 0 1 2 0 0 0 0 0 0 0 0 queues 1@0 1@6 1@7 hw 0

echo 106 &gt; /sys/class/net/eth0/queues/tx-7/tx_maxrate
echo 212 &gt; /sys/class/net/eth0/queues/tx-6/tx_maxrate

tc qdisc add dev eth0 clsact
tc filter add dev eth0 egress protocol ip prio 1 u32 match ip dport 5001 0xffff action skbedit priority 7
tc filter add dev eth0 egress protocol ip prio 1 u32 match ip dport 5002 0xffff action skbedit priority 6

iperf3 -c 192.168.1.2 -t10 -p5001 -Tpri7 &amp; \
iperf3 -c 192.168.1.2 -t10 -p5002 -Tpri6 &amp; \
iperf3 -c 192.168.1.2 -t10 -p5003 -Tpri0

#result
pri0:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri0:  [ ID] Interval           Transfer     Bitrate         Retr
pri0:  [  5]   0.00-10.00  sec   767 MBytes   644 Mbits/sec    0             sender
pri0:  [  5]   0.00-10.00  sec   766 MBytes   642 Mbits/sec                  receiver

pri6:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri6:  [ ID] Interval           Transfer     Bitrate         Retr
pri6:  [  5]   0.00-10.00  sec   238 MBytes   200 Mbits/sec    0             sender
pri6:  [  5]   0.00-10.01  sec   238 MBytes   199 Mbits/sec                  receiver

pri7:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri7:  [ ID] Interval           Transfer     Bitrate         Retr
pri7:  [  5]   0.00-10.00  sec   120 MBytes   101 Mbits/sec    0             sender
pri7:  [  5]   0.00-10.01  sec   119 MBytes  99.9 Mbits/sec                  receiver

#statistic
tx_pri0: 2819633
tx_pri1: 2
tx_pri2: 0
tx_pri3: 102
tx_pri4: 26
tx_pri5: 0
tx_pri6: 847449
tx_pri7: 1237148
</pre></div>
</div>
</div>
<div class="section" id="switch-egress-ethernet-port-transmit-rate-limiting-offload">
<h3><a class="toc-backref" href="#id3">3.2.2.10.3.3.2.3.1.2. Switch egress, Ethernet Port Transmit Rate Limiting offload</a><a class="headerlink" href="#switch-egress-ethernet-port-transmit-rate-limiting-offload" title="Permalink to this headline">¶</a></h3>
<p>The Linux MQPRIO Qdisc in channel offload mode can be used for mapping of packet priorities to traffic classes and configuring rate limit in Mbit/s per External Ports FIFOs.
The MQPRIO Qdisc <strong>shaper bw_rlimit min_rate and max_rate</strong> parameters can be used to configure External Ports FIFO shapers.</p>
<ul class="simple">
<li>the traffic class (TC) in terms of MQPRIO Qdisc is mapped 1:1 to External Ports FIFO. TC0 is lowest priority.</li>
<li>MQPRIO Qdisk offload is expected to work with VALN/priority tagged traffic first of all and untagged traffic has to be mapped only to TC0.</li>
<li>to handle properly untagged traffic from Host Port the 1:1 mapping has to be preserved between packet priority and Host TX DMA channel used to send packet</li>
<li>VALN/priority tagged packets mapped to TC0 will exit switch with VALN tag.</li>
<li>if Host sends traffic to the same, rate limited External Ports FIFO then corresponding Host TX DMA channel shapers has to be enabled and its rate has to be set equal or less than External Ports FIFO rate</li>
<li>the rate for shapers has to be set a little bit more then potential incoming rate, and real rates can differ, due to discreetness.</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span>tc qdisc add dev eth0 parent root handle 100: mqprio num_tc 3 \
map 0 0 0 0 0 0 1 2 0 0 0 0 0 0 0 0 \
queues 1@0 1@6 1@7 hw 1 mode channel \
shaper bw_rlimit min_rate 0 212mbit 106mbit max_rate 0 250mbit 150mbit
</pre></div>
</div>
<p class="rubric">Switch egress, Ethernet Port Transmit Rate Limiting example</p>
<p>In this example Rate Limiting is enabled for Host port TX channels and External Ports FIFO.</p>
<ul class="simple">
<li>tc filters are used to assign pri for iperf3 traffic using port as filter value</li>
<li>untagged traffic</li>
<li>pri7 traffic routed to TX DMA channel 7, rate limit 100Mbit</li>
<li>pri6 traffic routed to TX DMA channel 6, rate limit 200Mbit</li>
<li>pri0-5 traffic routed to TX DMA channel 0</li>
<li>pri7 traffic mapped to TC2, External Ports FIFO2, cir=100Mbit, eir=150Mbit</li>
<li>pri6 traffic mapped to TC1, External Ports FIFO1, cir=200Mbit, eir=250Mbit</li>
<li>pri0-5 traffic mapped to TC1, External Ports FIFO0</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span>ip link set dev eth0 down
ethtool -L eth0 tx 8
ip link set dev eth0 up

tc qdisc add dev eth0 parent root handle 100: mqprio num_tc 3 \
map 0 0 0 0 0 0 1 2 0 0 0 0 0 0 0 0 \
queues 1@0 1@6 1@7 hw 1 mode channel \
shaper bw_rlimit min_rate 0 212mbit 106mbit max_rate 0 250mbit 150mbit

echo 106 &gt; /sys/class/net/eth0/queues/tx-7/tx_maxrate
echo 212 &gt; /sys/class/net/eth0/queues/tx-6/tx_maxrate

tc qdisc add dev eth0 clsact
tc filter add dev eth0 egress protocol ip prio 1 u32 match ip dport 5001 0xffff action skbedit priority 7
tc filter add dev eth0 egress protocol ip prio 1 u32 match ip dport 5002 0xffff action skbedit priority 6

iperf3 -c 192.168.1.2 -t10 -p5001 -Tpri7 &amp; \
iperf3 -c 192.168.1.2 -t10 -p5002 -Tpri6 &amp; \
iperf3 -c 192.168.1.2 -t10 -p5003 -Tpri0

#result
pri7:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri7:  [ ID] Interval           Transfer     Bitrate         Retr
pri7:  [  5]   0.00-10.00  sec   120 MBytes   100 Mbits/sec    0             sender
pri7:  [  5]   0.00-10.00  sec   119 MBytes  99.9 Mbits/sec                  receiver

pri6:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri6:  [ ID] Interval           Transfer     Bitrate         Retr
pri6:  [  5]   0.00-10.00  sec   238 MBytes   200 Mbits/sec    0             sender
pri6:  [  5]   0.00-10.00  sec   238 MBytes   199 Mbits/sec                  receiver

pri0:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri0:  [ ID] Interval           Transfer     Bitrate         Retr
pri0:  [  5]   0.00-10.00  sec   767 MBytes   643 Mbits/sec    0             sender
pri0:  [  5]   0.00-10.00  sec   766 MBytes   642 Mbits/sec                  receiver

#statistic
tx_pri0: 2012441
tx_pri1: 172147
tx_pri2: 259038
tx_pri3: 0
tx_pri4: 2
tx_pri5: 9
tx_pri6: 0
tx_pri7: 0
</pre></div>
</div>
</div>
</div>
<div class="section" id="cbs-in-mac-mode">
<h2><a class="toc-backref" href="#id4">3.2.2.10.3.3.2.3.2. CBS in MAC mode</a><a class="headerlink" href="#cbs-in-mac-mode" title="Permalink to this headline">¶</a></h2>
<div class="section" id="rate-limiting-host-port-ingress-on-am625-sk">
<h3><a class="toc-backref" href="#id5">3.2.2.10.3.3.2.3.2.1. Rate-limiting Host Port Ingress on AM625-SK</a><a class="headerlink" href="#rate-limiting-host-port-ingress-on-am625-sk" title="Permalink to this headline">¶</a></h3>
<p>Connect eth0 of AM625-SK to eth1 of J7VCL.</p>
<p><strong>Steps:</strong></p>
<ol class="arabic simple">
<li>Create and run the following script on AM625-SK:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>#!/bin/sh

ifconfig eth0 down
ifconfig eth1 down
ethtool -L eth0 tx 8
ifconfig eth0 up
ifconfig eth0 192.168.1.1

sleep 10

tc qdisc replace dev eth0 handle 100: parent root mqprio num_tc 3 \
map 0 0 0 0 0 0 1 2 0 0 0 0 0 0 0 0 queues 1@0 1@6 1@7 hw 0

echo 106 &gt; /sys/class/net/eth0/queues/tx-7/tx_maxrate
echo 212 &gt; /sys/class/net/eth0/queues/tx-6/tx_maxrate

tc qdisc add dev eth0 clsact
tc filter add dev eth0 egress protocol ip prio 1 u32 match ip dport 5001 0xffff action skbedit priority 7
tc filter add dev eth0 egress protocol ip prio 1 u32 match ip dport 5002 0xffff action skbedit priority 6
</pre></div>
</div>
<p>In the above script,  the tx queues that send data to the host port are rate-
limited using the following commands:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># Rate limit tx queue 7 of eth0 to 106 Mbps
echo 106 &gt; /sys/class/net/eth0/queues/tx-7/tx_maxrate
# Rate limit tx queue 6 of eth0 to 212 Mbps
echo 212 &gt; /sys/class/net/eth0/queues/tx-6/tx_maxrate
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Next, assign IP address of 192.168.1.2 to Port-1 of the CPSW5G ports on J7VCL using:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>ifconfig eth1 192.168.1.2
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Next, start an iperf server on J7VCL by running:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>iperf3 -s -p 5001&amp;
iperf3 -s -p 5002&amp;
iperf3 -s -p 5003&amp;
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Now, run the iperf client on AM625-SK using:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>iperf3 -c 192.168.1.2 -t10 -p5001 -Tpri7 &amp; \
iperf3 -c 192.168.1.2 -t10 -p5002 -Tpri6 &amp; \
iperf3 -c 192.168.1.2 -t10 -p5003 -Tpri0
</pre></div>
</div>
<p><strong>Results:</strong></p>
<p>On AM625-SK:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>pri0:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri0:  [ ID] Interval           Transfer     Bitrate         Retr
pri0:  [  5]   0.00-10.00  sec   738 MBytes   619 Mbits/sec  162             sender
pri0:  [  5]   0.00-10.00  sec   735 MBytes   617 Mbits/sec                  receiver
pri0:
pri0:  iperf Done.
pri6:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri6:  [ ID] Interval           Transfer     Bitrate         Retr
pri6:  [  5]   0.00-10.00  sec   221 MBytes   185 Mbits/sec   69             sender
pri6:  [  5]   0.00-10.01  sec   220 MBytes   184 Mbits/sec                  receiver
pri6:
pri6:  iperf Done.
pri7:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri7:  [ ID] Interval           Transfer     Bitrate         Retr
pri7:  [  5]   0.00-10.00  sec   115 MBytes  96.5 Mbits/sec   37             sender
pri7:  [  5]   0.00-10.01  sec   114 MBytes  95.9 Mbits/sec                  receiver
pri7:
pri7:  iperf Done.
</pre></div>
</div>
</div>
<div class="section" id="rate-limiting-host-port-ingress-on-j7vcl">
<h3><a class="toc-backref" href="#id6">3.2.2.10.3.3.2.3.2.2. Rate-limiting Host Port Ingress on J7VCL</a><a class="headerlink" href="#rate-limiting-host-port-ingress-on-j7vcl" title="Permalink to this headline">¶</a></h3>
<p>Connect eth1 of J7VCL to eth0 of AM625-SK.</p>
<p><strong>Steps:</strong></p>
<ol class="arabic simple">
<li>Create and run the following script on J7VCL:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>#!/bin/sh

ifconfig eth1 down
ifconfig eth2 down
ifconfig eth3 down
ifconfig eth4 down
ethtool -L eth1 tx 8
ifconfig eth1 up
ifconfig eth1 192.168.1.1

sleep 10

tc qdisc replace dev eth1 handle 100: parent root mqprio num_tc 3 \
map 0 0 0 0 0 0 1 2 0 0 0 0 0 0 0 0 queues 1@0 1@6 1@7 hw 0

echo 106 &gt; /sys/class/net/eth1/queues/tx-7/tx_maxrate
echo 212 &gt; /sys/class/net/eth1/queues/tx-6/tx_maxrate

tc qdisc add dev eth1 clsact
tc filter add dev eth1 egress protocol ip prio 1 u32 match ip dport 5001 0xffff action skbedit priority 7
tc filter add dev eth1 egress protocol ip prio 1 u32 match ip dport 5002 0xffff action skbedit priority 6
</pre></div>
</div>
<p>In the above script,  the tx queues that send data to the host port are rate-
limited using the following commands:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># Rate limit tx queue 7 of eth0 to 106 Mbps
echo 106 &gt; /sys/class/net/eth0/queues/tx-7/tx_maxrate
# Rate limit tx queue 6 of eth0 to 212 Mbps
echo 212 &gt; /sys/class/net/eth0/queues/tx-6/tx_maxrate
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Next, assign IP address of 192.168.1.2 to Port-1 of the CPSW3G ports on AM625-SK using:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>ifconfig eth0 192.168.1.2
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Next, start an iperf server on AM625-SK by running:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>iperf3 -s -p 5001&amp;
iperf3 -s -p 5002&amp;
iperf3 -s -p 5003&amp;
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Now, run the iperf client on J7VCL using:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>iperf3 -c 192.168.1.2 -t10 -p5001 -Tpri7 &amp; \
iperf3 -c 192.168.1.2 -t10 -p5002 -Tpri6 &amp; \
iperf3 -c 192.168.1.2 -t10 -p5003 -Tpri0
</pre></div>
</div>
<p><strong>Results:</strong></p>
<p>On J7VCL:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>pri0:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri0:  [ ID] Interval           Transfer     Bitrate         Retr
pri0:  [  5]   0.00-10.00  sec   759 MBytes   637 Mbits/sec    0             sender
pri0:  [  5]   0.00-10.00  sec   756 MBytes   635 Mbits/sec                  receiver
pri0:
pri0:  iperf Done.
pri7:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri7:  [ ID] Interval           Transfer     Bitrate         Retr
pri7:  [  5]   0.00-10.00  sec   118 MBytes  98.7 Mbits/sec    0             sender
pri7:  [  5]   0.00-10.01  sec   117 MBytes  97.9 Mbits/sec                  receiver
pri7:
pri7:  iperf Done.
pri6:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri6:  [ ID] Interval           Transfer     Bitrate         Retr
pri6:  [  5]   0.00-10.00  sec   234 MBytes   196 Mbits/sec    0             sender
pri6:  [  5]   0.00-10.01  sec   233 MBytes   195 Mbits/sec                  receiver
pri6:
pri6:  iperf Done.
</pre></div>
</div>
</div>
<div class="section" id="rate-limiting-switch-egress-on-am625-sk-data-sent-from-host-port-of-am625-sk-to-j7vcl">
<h3><a class="toc-backref" href="#id7">3.2.2.10.3.3.2.3.2.3. Rate-limiting Switch Egress on AM625-SK (Data sent from Host Port of AM625-SK to J7VCL)</a><a class="headerlink" href="#rate-limiting-switch-egress-on-am625-sk-data-sent-from-host-port-of-am625-sk-to-j7vcl" title="Permalink to this headline">¶</a></h3>
<p>Connect eth0 of AM625-SK to eth1 of J7VCL.</p>
<p><strong>Steps:</strong></p>
<ol class="arabic simple">
<li>Create and run the following script on AM625-SK:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>#!/bin/sh

ifconfig eth0 down
ifconfig eth1 down
ethtool -L eth0 tx 8
ifconfig eth0 up
ifconfig eth0 192.168.1.1

sleep 10

tc qdisc add dev eth0 parent root handle 100: mqprio num_tc 3 \
map 0 0 0 0 0 0 1 2 0 0 0 0 0 0 0 0 \
queues 1@0 1@6 1@7 hw 1 mode channel \
shaper bw_rlimit min_rate 0 212mbit 106mbit max_rate 0 250mbit 150mbit

echo 106 &gt; /sys/class/net/eth0/queues/tx-7/tx_maxrate
echo 212 &gt; /sys/class/net/eth0/queues/tx-6/tx_maxrate

tc qdisc add dev eth0 clsact
tc filter add dev eth0 egress protocol ip prio 1 u32 match ip dport 5001 0xffff action skbedit priority 7
tc filter add dev eth0 egress protocol ip prio 1 u32 match ip dport 5002 0xffff action skbedit priority 6
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Assign IP address of 192.168.1.2 to Port-1 of the CPSW5G ports on J7VCL using:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>ifconfig eth1 192.168.1.2
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Next, start an iperf server on J7VCL using:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>iperf3 -s -p 5001&amp;
iperf3 -s -p 5002&amp;
iperf3 -s -p 5003&amp;
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Now, run the iperf client on AM625-SK using:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>iperf3 -c 192.168.1.2 -t10 -p5001 -Tpri7 &amp; \
iperf3 -c 192.168.1.2 -t10 -p5002 -Tpri6 &amp; \
iperf3 -c 192.168.1.2 -t10 -p5003 -Tpri0
</pre></div>
</div>
<p><strong>Results:</strong></p>
<p>On AM625-SK:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>pri7:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri7:  [ ID] Interval           Transfer     Bitrate         Retr
pri7:  [  5]   0.00-10.00  sec   116 MBytes  97.1 Mbits/sec   17             sender
pri7:  [  5]   0.00-10.00  sec   115 MBytes  96.5 Mbits/sec                  receiver
pri7:
pri7:  iperf Done.
pri6:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri6:  [ ID] Interval           Transfer     Bitrate         Retr
pri6:  [  5]   0.00-10.00  sec   226 MBytes   190 Mbits/sec   33             sender
pri6:  [  5]   0.00-10.01  sec   225 MBytes   189 Mbits/sec                  receiver
pri6:
pri6:  iperf Done.
pri0:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri0:  [ ID] Interval           Transfer     Bitrate         Retr
pri0:  [  5]   0.00-10.00  sec   716 MBytes   601 Mbits/sec   42             sender
pri0:  [  5]   0.00-10.00  sec   714 MBytes   598 Mbits/sec                  receiver
pri0:
pri0:  iperf Done.
</pre></div>
</div>
</div>
<div class="section" id="rate-limiting-switch-egress-on-j7vcl-data-sent-from-host-port-of-j7vcl-to-am625-sk">
<h3><a class="toc-backref" href="#id8">3.2.2.10.3.3.2.3.2.4. Rate-limiting Switch Egress on J7VCL (Data sent from Host Port of J7VCL to AM625-SK)</a><a class="headerlink" href="#rate-limiting-switch-egress-on-j7vcl-data-sent-from-host-port-of-j7vcl-to-am625-sk" title="Permalink to this headline">¶</a></h3>
<p>Connect eth1 of J7VCL to eth0 of AM625-SK.</p>
<p><strong>Steps:</strong></p>
<ol class="arabic simple">
<li>Create and run the following script on J7VCL:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>#!/bin/sh

ifconfig eth1 down
ifconfig eth2 down
ifconfig eth3 down
ifconfig eth4 down
ethtool -L eth1 tx 8
ifconfig eth1 up
ifconfig eth1 192.168.1.1

sleep 10

tc qdisc add dev eth1 parent root handle 100: mqprio num_tc 3 \
map 0 0 0 0 0 0 1 2 0 0 0 0 0 0 0 0 \
queues 1@0 1@6 1@7 hw 1 mode channel \
shaper bw_rlimit min_rate 0 212mbit 106mbit max_rate 0 250mbit 150mbit

echo 106 &gt; /sys/class/net/eth1/queues/tx-7/tx_maxrate
echo 212 &gt; /sys/class/net/eth1/queues/tx-6/tx_maxrate

tc qdisc add dev eth1 clsact
tc filter add dev eth1 egress protocol ip prio 1 u32 match ip dport 5001 0xffff action skbedit priority 7
tc filter add dev eth1 egress protocol ip prio 1 u32 match ip dport 5002 0xffff action skbedit priority 6
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Assign IP address of 192.168.1.2 to Port-1 of the CPSW3G ports on AM625-SK using:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>ifconfig eth0 192.168.1.2
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Next, start an iperf server on AM625-SK using:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>iperf3 -s -p 5001&amp;
iperf3 -s -p 5002&amp;
iperf3 -s -p 5003&amp;
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Now, run the iperf client on J7VCL using:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>iperf3 -c 192.168.1.2 -t10 -p5001 -Tpri7 &amp; \
iperf3 -c 192.168.1.2 -t10 -p5002 -Tpri6 &amp; \
iperf3 -c 192.168.1.2 -t10 -p5003 -Tpri0
</pre></div>
</div>
<p><strong>Results:</strong></p>
<p>On J7VCL:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>pri0:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri0:  [ ID] Interval           Transfer     Bitrate         Retr
pri0:  [  5]   0.00-10.00  sec   746 MBytes   626 Mbits/sec    0             sender
pri0:  [  5]   0.00-10.00  sec   744 MBytes   624 Mbits/sec                  receiver
pri0:
pri0:  iperf Done.
pri6:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri6:  [ ID] Interval           Transfer     Bitrate         Retr
pri6:  [  5]   0.00-10.00  sec   234 MBytes   196 Mbits/sec    0             sender
pri6:  [  5]   0.00-10.01  sec   233 MBytes   195 Mbits/sec                  receiver
pri6:
pri6:  iperf Done.
pri7:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri7:  [ ID] Interval           Transfer     Bitrate         Retr
pri7:  [  5]   0.00-10.00  sec   119 MBytes  99.4 Mbits/sec    0             sender
pri7:  [  5]   0.00-10.01  sec   117 MBytes  98.3 Mbits/sec                  receiver
pri7:
pri7:  iperf Done.
</pre></div>
</div>
</div>
</div>
<div class="section" id="cbs-in-switch-mode">
<h2><a class="toc-backref" href="#id9">3.2.2.10.3.3.2.3.3. CBS in Switch mode</a><a class="headerlink" href="#cbs-in-switch-mode" title="Permalink to this headline">¶</a></h2>
<p>Rate-limiting is implemented on the sender and the switch, with the rate-
limiting on the switch being stricter than the sender. This is done due
to the size limit of the TX FIFO queue.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All three devices (AM625-SK, AM64-SK and J7VCL) must be a part of the
same VLAN, to ensure that the priority field is included in the
packets, enabling the switch to identify the priority and rate-limit
traffic accordingly.</p>
</div>
<div class="section" id="rate-limiting-switch-egress-on-am625-sk-data-sent-from-am64-sk-to-j7vcl-via-am625-sk-switch">
<h3><a class="toc-backref" href="#id10">3.2.2.10.3.3.2.3.3.1. Rate limiting Switch Egress on AM625-SK (Data sent from AM64-SK to J7VCL via AM625-SK switch)</a><a class="headerlink" href="#rate-limiting-switch-egress-on-am625-sk-data-sent-from-am64-sk-to-j7vcl-via-am625-sk-switch" title="Permalink to this headline">¶</a></h3>
<p>Connect AM64-SK’s eth0 to AM625-SK’s eth0 and J7VCL’s eth1 to AM625-SK’s
eth1.</p>
<p><strong>Steps:</strong></p>
<ol class="arabic simple">
<li>Create and run the following script on AM625-SK:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>#!/bin/sh
ifconfig eth0 down
ifconfig eth1 down
ethtool -L eth1 tx 8
ethtool --set-priv-flags eth1 p0-rx-ptype-rrobin off

devlink dev param set platform/8000000.ethernet name switch_mode value true cmode runtime
ip link add name br0 type bridge
ip link set dev br0 type bridge ageing_time 1000
ip link set dev eth0 up
ip link set dev eth1 up
sleep 10

ip link set dev eth0 master br0
ip link set dev eth1 master br0
ip link set dev br0 up
ip link set dev br0 type bridge vlan_filtering 1
bridge vlan add dev br0 vid 1 pvid untagged self
bridge vlan add dev eth0 vid 100 master
bridge vlan add dev eth1 vid 100 master


tc qdisc add dev eth1 parent root handle 100: mqprio num_tc 3 \
map 0 0 0 0 0 0 1 2 0 0 0 0 0 0 0 0 \
queues 1@0 1@6 1@7 hw 1 mode channel \
shaper bw_rlimit min_rate 99mbit 211mbit 105mbit max_rate 100mbit 212mbit 106mbit
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Create and run the following script on AM64-SK:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>#!/bin/sh

ifconfig eth0 down
ifconfig eth1 down
ethtool -L eth0 tx 8
ifconfig eth0 up
sleep 5

ip link add link eth0 name eth0.100 type vlan id 100
ip link set eth0.100 type vlan egress 0:0 1:1 2:2 3:3 4:4 5:5 6:6 7:7
sleep 5
ifconfig eth0.100 192.168.1.1 netmask 255.255.255.0
sleep 2

echo 106 &gt; /sys/class/net/eth0/queues/tx-7/tx_maxrate
echo 212 &gt; /sys/class/net/eth0/queues/tx-6/tx_maxrate

tc qdisc add dev eth0.100 clsact
tc filter add dev eth0.100 egress protocol ip prio 1 u32 match ip dport 5001 0xffff action skbedit priority 7
tc filter add dev eth0.100 egress protocol ip prio 1 u32 match ip dport 5002 0xffff action skbedit priority 6

tc qdisc add dev eth0 parent root handle 100: mqprio num_tc 3 \
map 0 0 0 0 0 0 1 2 0 0 0 0 0 0 0 0 \
queues 1@0 1@6 1@7 hw 1 mode channel \
shaper bw_rlimit min_rate 101mbit 213mbit 107mbit max_rate 102mbit 214mbit 108mbit
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Create and run the following scripts on J7VCL:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>#!/bin/sh

ip link add link eth1 name eth1.100 type vlan id 100
sleep 5
ifconfig eth1.100 192.168.1.2 netmask 255.255.255.0
sleep 2
iperf3 -s -p 5001&amp;
iperf3 -s -p 5002&amp;
iperf3 -s -p 5003&amp;
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Now, run the iperf client on AM64-SK using the following commands:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>iperf3 -c 192.168.1.2 -u -b108M -t10 -p5001 -Tpri7 &amp; \
iperf3 -c 192.168.1.2 -u -b214M -t10 -p5002 -Tpri6 &amp; \
iperf3 -c 192.168.1.2 -u -b102M -t10 -p5003 -Tpri0
</pre></div>
</div>
<p><strong>Results:</strong></p>
<div class="highlight-text"><div class="highlight"><pre><span></span>pri7:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri7:  [ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams
pri7:  [  5]   0.00-10.00  sec   120 MBytes   101 Mbits/sec  0.000 ms  0/87099 (0%)  sender
pri7:  [  5]   0.00-10.01  sec   115 MBytes  96.6 Mbits/sec  0.027 ms  3682/87099 (4.2%)  receiver
pri7:
pri7:  iperf Done.
pri6:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri6:  [ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams
pri6:  [  5]   0.00-10.00  sec   241 MBytes   202 Mbits/sec  0.000 ms  0/174308 (0%)  sender
pri6:  [  5]   0.00-10.00  sec   228 MBytes   191 Mbits/sec  0.104 ms  9203/174308 (5.3%)  receiver
pri6:
pri6:  iperf Done.
pri0:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri0:  [ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams
pri0:  [  5]   0.00-10.00  sec   116 MBytes  97.3 Mbits/sec  0.000 ms  0/84000 (0%)  sender
pri0:  [  5]   0.00-10.00  sec   114 MBytes  95.3 Mbits/sec  0.028 ms  1700/83958 (2%)  receiver
pri0:
pri0:  iperf Done.
</pre></div>
</div>
</div>
<div class="section" id="rate-limiting-switch-egress-on-j7vcl-data-sent-from-am64-sk-to-am625-sk-via-j7vcl-switch">
<h3><a class="toc-backref" href="#id11">3.2.2.10.3.3.2.3.3.2. Rate-limiting Switch Egress on J7VCL (Data sent from AM64-SK to AM625-SK via J7VCL switch)</a><a class="headerlink" href="#rate-limiting-switch-egress-on-j7vcl-data-sent-from-am64-sk-to-am625-sk-via-j7vcl-switch" title="Permalink to this headline">¶</a></h3>
<p>Connect AM64-SK’s eth0 to J7VCL’s eth1 and AM625-SK’s eth0 to J7VCL’s eth2.</p>
<p><strong>Steps:</strong></p>
<ol class="arabic simple">
<li>Create and run the following script on J7VCL:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>#!/bin/sh
ifconfig eth1 down
ifconfig eth2 down
ifconfig eth3 down
ifconfig eth4 down
ethtool -L eth2 tx 8
ethtool --set-priv-flags eth2 p0-rx-ptype-rrobin off

devlink dev param set platform/c000000.ethernet name switch_mode value true cmode runtime
ip link add name br0 type bridge
ip link set dev br0 type bridge ageing_time 1000
ip link set dev eth1 up
ip link set dev eth2 up
sleep 10

ip link set dev eth1 master br0
ip link set dev eth2 master br0
ip link set dev br0 up
ip link set dev br0 type bridge vlan_filtering 1
bridge vlan add dev br0 vid 1 pvid untagged self
bridge vlan add dev eth1 vid 100 master
bridge vlan add dev eth2 vid 100 master


tc qdisc add dev eth2 parent root handle 100: mqprio num_tc 3 \
map 0 0 0 0 0 0 1 2 0 0 0 0 0 0 0 0 \
queues 1@0 1@6 1@7 hw 1 mode channel \
shaper bw_rlimit min_rate 99mbit 211mbit 105mbit max_rate 100mbit 212mbit 106mbit
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Create and run the following script on AM64-SK:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>#!/bin/sh

ifconfig eth0 down
ifconfig eth1 down
ethtool -L eth0 tx 8
ifconfig eth0 up
sleep 5

ip link add link eth0 name eth0.100 type vlan id 100
ip link set eth0.100 type vlan egress 0:0 1:1 2:2 3:3 4:4 5:5 6:6 7:7
sleep 5
ifconfig eth0.100 192.168.1.1 netmask 255.255.255.0
sleep 2

echo 106 &gt; /sys/class/net/eth0/queues/tx-7/tx_maxrate
echo 212 &gt; /sys/class/net/eth0/queues/tx-6/tx_maxrate

tc qdisc add dev eth0.100 clsact
tc filter add dev eth0.100 egress protocol ip prio 1 u32 match ip dport 5001 0xffff action skbedit priority 7
tc filter add dev eth0.100 egress protocol ip prio 1 u32 match ip dport 5002 0xffff action skbedit priority 6

tc qdisc add dev eth0 parent root handle 100: mqprio num_tc 3 \
map 0 0 0 0 0 0 1 2 0 0 0 0 0 0 0 0 \
queues 1@0 1@6 1@7 hw 1 mode channel \
shaper bw_rlimit min_rate 101mbit 213mbit 107mbit max_rate 102mbit 214mbit 108mbit
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Create and run the following script on AM625-SK:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>#!/bin/sh

ip link add link eth0 name eth0.100 type vlan id 100
sleep 5
ifconfig eth0.100 192.168.1.2 netmask 255.255.255.0
sleep 2
iperf3 -s -p 5001&amp;
iperf3 -s -p 5002&amp;
iperf3 -s -p 5003&amp;
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Now, run the iperf client on AM64-SK using the following commands:</li>
</ol>
<div class="highlight-text"><div class="highlight"><pre><span></span>iperf3 -c 192.168.1.2 -u -b108M -t10 -p5001 -Tpri7 &amp; \
iperf3 -c 192.168.1.2 -u -b214M -t10 -p5002 -Tpri6 &amp; \
iperf3 -c 192.168.1.2 -u -b102M -t10 -p5003 -Tpri0
</pre></div>
</div>
<p><strong>Results:</strong></p>
<div class="highlight-text"><div class="highlight"><pre><span></span>pri6:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri6:  [ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams
pri6:  [  5]   0.00-10.00  sec   240 MBytes   201 Mbits/sec  0.000 ms  0/173574 (0%)  sender
pri6:  [  5]   0.00-10.03  sec   215 MBytes   180 Mbits/sec  0.083 ms  18116/173574 (10%)  receiver
pri6:
pri6:  iperf Done.
pri7:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri7:  [ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams
pri7:  [  5]   0.00-10.00  sec   120 MBytes   101 Mbits/sec  0.000 ms  0/86842 (0%)  sender
pri7:  [  5]   0.00-10.05  sec   117 MBytes  97.5 Mbits/sec  0.010 ms  2279/86842 (2.6%)  receiver
pri7:
pri7:  iperf Done.
pri0:  - - - - - - - - - - - - - - - - - - - - - - - - -
pri0:  [ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams
pri0:  [  5]   0.00-10.00  sec   116 MBytes  97.2 Mbits/sec  0.000 ms  0/83913 (0%)  sender
pri0:  [  5]   0.00-10.01  sec   113 MBytes  95.1 Mbits/sec  0.009 ms  1683/83848 (2%)  receiver
pri0:
pri0:  iperf Done.
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="CPSW-IET.html" class="btn btn-neutral float-right" title="3.2.2.10.3.3.2.4. IET" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="CPSW-EST.html" class="btn btn-neutral" title="3.2.2.10.3.3.2.2. EST" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
      <a href="http://www.ti.com/corp/docs/legal/copyright.shtml">&copy; Copyright 1995-2021</a>, Texas Instruments Incorporated. All rights reserved. <br>
      <a href="http://www.ti.com/corp/docs/legal/trademark/trademrk.htm">Trademarks</a> | <a href="http://www.ti.com/corp/docs/legal/privacy.shtml">Privacy policy</a> | <a href="http://www.ti.com/corp/docs/legal/termsofuse.shtml">Terms of use</a> | <a href="http://www.ti.com/lsds/ti/legal/termsofsale.page">Terms of sale</a>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../../',
            VERSION:'08_06_00',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>

  

  
  
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
        });

      var menuHeight = window.innerHeight;

      var contentOffset = $(".wy-nav-content-wrap").offset();
      var contentHeight = $(".wy-nav-content-wrap").height();
      var contentBottom = contentOffset.top + contentHeight;

      function setNavbarTop() {
          var scrollTop = $(window).scrollTop();
          var maxTop = scrollTop + menuHeight;

          // If past the header
          if (scrollTop > contentOffset.top && maxTop < contentBottom) {
            stickyTop = scrollTop - contentOffset.top;
          } else if (maxTop > contentBottom) {
            stickyTop = scrollTop - contentOffset.top - (maxTop - contentBottom);
          } else {
            stickyTop = 0;
          }

          $(".wy-nav-side").css("top", stickyTop);
      }

      $(document).ready(function() {
        setNavbarTop();
        $(window).scroll(function () {
          setNavbarTop();
        });
      });
  </script>
   

</body>
</html>


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.2.2.17. SPI &mdash; Processor SDK Linux for J721e Documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../search.html"/>
    <link rel="top" title="Processor SDK Linux for J721e Documentation" href="../../../../index.html"/>
        <link rel="up" title="3.2.2. Kernel Drivers" href="../../../Foundational_Components_Kernel_Drivers.html"/>
        <link rel="next" title="3.2.2.18. NAND" href="Storage/NAND.html"/>
        <link rel="prev" title="3.2.2.16. SERDES" href="SERDES/SERDES.html"/> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">
  <header id="tiHeader">
    <div class="top">
      <ul>
        <li id="top_logo">
          <a href="http://www.ti.com">
            <img src="../../../../_static/img/ti_logo.png"/>
          </a>
        </li>
      </ul>
    </div>
    <div class="nav"></div>
  </header>
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../devices/J7/linux/index.html" class="icon icon-home"> Processor SDK Linux for J721e
          

          
          </a>

          
            
            
              <div class="version">
                08_06_00
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../Overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../devices/J7/linux/Release_Specific.html">2. Release Specific</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../Foundational_Components.html">3. Foundational Components</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../Foundational_Components_U-Boot.html">3.1. U-Boot</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../Foundational_Components_Kernel.html">3.2. Kernel</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../../Foundational_Components_Kernel_Users_Guide.html">3.2.1. Users Guide</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../../Foundational_Components_Kernel_Drivers.html">3.2.2. Kernel Drivers</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="ADC.html">3.2.2.1. ADC</a></li>
<li class="toctree-l4"><a class="reference internal" href="Audio.html">3.2.2.2. Audio</a></li>
<li class="toctree-l4"><a class="reference internal" href="Camera/CSI2RX.html">3.2.2.3. CSI2RX</a></li>
<li class="toctree-l4"><a class="reference internal" href="Crypto.html">3.2.2.4. Crypto</a></li>
<li class="toctree-l4"><a class="reference internal" href="MCAN.html">3.2.2.5. MCAN</a></li>
<li class="toctree-l4"><a class="reference internal" href="Display/DSS7.html">3.2.2.6. DSS</a></li>
<li class="toctree-l4"><a class="reference internal" href="GPIO.html">3.2.2.7. GPIO</a></li>
<li class="toctree-l4"><a class="reference internal" href="HYPERFLASH.html">3.2.2.8. HyperBus and HyperFlash</a></li>
<li class="toctree-l4"><a class="reference internal" href="I2C.html">3.2.2.9. I2C</a></li>
<li class="toctree-l4"><a class="reference internal" href="Network/CPSW-Ethernet.html">3.2.2.10. CPSW Ethernet</a></li>
<li class="toctree-l4"><a class="reference internal" href="PCIe/PCIe_End_Point.html">3.2.2.11. PCIe End Point</a></li>
<li class="toctree-l4"><a class="reference internal" href="PCIe/PCIe_Backplane.html">3.2.2.12. PCIe Backplane</a></li>
<li class="toctree-l4"><a class="reference internal" href="PCIe/PCIe_Root_Complex.html">3.2.2.13. PCIe Root Complex</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Foundational_Components_Kernel_Drivers_Power_Management.html">3.2.2.14. Power Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="QSPI.html">3.2.2.15. OSPI/QSPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="SERDES/SERDES.html">3.2.2.16. SERDES</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">3.2.2.17. SPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="Storage/NAND.html">3.2.2.18. NAND</a></li>
<li class="toctree-l4"><a class="reference internal" href="Storage/MMC-SD.html">3.2.2.19. MMC/SD</a></li>
<li class="toctree-l4"><a class="reference internal" href="UART.html">3.2.2.20. UART</a></li>
<li class="toctree-l4"><a class="reference internal" href="UFS.html">3.2.2.21. UFS</a></li>
<li class="toctree-l4"><a class="reference internal" href="USB/CDNS3.html">3.2.2.22. USB</a></li>
<li class="toctree-l4"><a class="reference internal" href="VTM.html">3.2.2.23. Voltage &amp; Thermal Management (VTM)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../Foundational_Components_Kernel_LTP-DDT_Validation.html">3.2.3. LTP-DDT Validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../Foundational_Components_Kernel_FAQs.html">3.2.4. FAQs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../Foundational_Components_Filesystem.html">3.3. Filesystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Foundational_Components_Tools.html">3.4. Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Foundational_Components_IPCLLD.html">3.5. IPC Low Level Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Foundational_Components_Graphics.html">3.6. Graphics and Display</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Foundational_Components_Multimedia_D5520_VXE384.html">3.7. Multimedia Video Codec</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Foundational_Components_Virtualization.html">3.8. Virtualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Foundational_Components_ATF.html">3.9. ARM Trusted Firmware-A</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Foundational_Components_OPTEE.html">3.10. OP-TEE</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../How_to_Guides.html">4. How to Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Documentation_Tarball.html">5. Documentation Tarball</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../devices/J7/linux/index.html">Processor SDK Linux for J721e</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../devices/J7/linux/index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../Foundational_Components.html">3. Foundational Components</a> &raquo;</li>
      
          <li><a href="../../../Foundational_Components_Kernel.html">3.2. Kernel</a> &raquo;</li>
      
          <li><a href="../../../Foundational_Components_Kernel_Drivers.html">3.2.2. Kernel Drivers</a> &raquo;</li>
      
    <li>3.2.2.17. SPI</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="spi">
<h1>3.2.2.17. SPI<a class="headerlink" href="#spi" title="Permalink to this headline">¶</a></h1>
<p class="rubric" id="introduction-linux-spi"><strong>Introduction</strong></p>
<ul class="simple">
<li>Serial interface</li>
<li>Synchronous</li>
<li>Master-slave configuration</li>
<li>Data Exchange - DMA/PIO</li>
</ul>
<p class="rubric" id="soc-specific-information">SOC Specific Information</p>
<table border="1" class="docutils">
<colgroup>
<col width="56%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">SoC Family</th>
<th class="head">Driver</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>AM335x</td>
<td>McSPI</td>
</tr>
<tr class="row-odd"><td>AM437x</td>
<td>McSPI</td>
</tr>
<tr class="row-even"><td>DRA7x</td>
<td>McSPI</td>
</tr>
<tr class="row-odd"><td>J721E</td>
<td>McSPI</td>
</tr>
<tr class="row-even"><td>J7200</td>
<td>McSPI</td>
</tr>
<tr class="row-odd"><td>J721S2</td>
<td>McSPI</td>
</tr>
<tr class="row-even"><td>AM62X</td>
<td>McSPI</td>
</tr>
<tr class="row-odd"><td>66AK2Gx</td>
<td>McSPI</td>
</tr>
<tr class="row-even"><td>66AK2Lx</td>
<td>Davinci</td>
</tr>
<tr class="row-odd"><td>66AK2Hx</td>
<td>Davinci</td>
</tr>
<tr class="row-even"><td>66AK2E</td>
<td>Davinci</td>
</tr>
</tbody>
</table>
<p class="rubric" id="spi-features-not-supported">Features Not Supported</p>
<p>Below contains a list of features not supported by the Linux driver.
Note this isn’t meant to be an exhaustive list and only takes into
account features the SPI peripheral in the SoC is capable of but is
currently not supported in the Linux driver.</p>
<ul class="simple">
<li>SPI slave mode is supported only with DMA enabled.</li>
</ul>
<p class="rubric">Kernel Configuration</p>
<p>The specific peripheral driver to enable depends on the SoC being used.</p>
<p class="rubric" id="enabling-mcspi-driver">Enabling McSPI Driver</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Device Drivers  ---&gt;
   [*] SPI support
      [*] McSPI driver for OMAP
</pre></div>
</div>
<p class="rubric" id="enabling-davinci-driver">Enabling DaVinci Driver</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Device Drivers  ---&gt;
   [*] SPI support
      [*] Texas Instruments DaVinci/DA8x/OMAP-L/AM1x SoC SPI controller
</pre></div>
</div>
<p class="rubric" id="spi-driver-usecases">SPI Driver Usecases</p>
<p>There are numerous drivers that can be used to interact with a variety
of hardware. From SPI based RTC to SPI based GPIO expander. A list of
drivers along with their documentation can be found within the kernel
sources. The below section attempts to provide information on SPI based
chips that are located on TI’s evms.</p>
<p class="rubric" id="flash-storage">Flash Storage</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section is not to be confused with flash storage through
the QSPI/OSPI modules.</p>
</div>
<p class="rubric" id="boards-with-spi-flash">Boards with SPI Flash</p>
<table border="1" class="docutils">
<colgroup>
<col width="35%" />
<col width="38%" />
<col width="27%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">EVM</th>
<th class="head">Part #</th>
<th class="head">Flash Size</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>AM335x ICE EVM</td>
<td>W25Q64</td>
<td>8 MB</td>
</tr>
<tr class="row-odd"><td>K2E EVM</td>
<td>N25Q128A11ESF40F</td>
<td>16 MB</td>
</tr>
<tr class="row-even"><td>K2HK EVM</td>
<td>N25Q128A11ESF40F</td>
<td>16 MB</td>
</tr>
<tr class="row-odd"><td>K2L EVM</td>
<td>N25Q128A11ESF40F</td>
<td>16 MB</td>
</tr>
</tbody>
</table>
<p class="rubric" id="kernel-configuration-1">Kernel Configuration</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Device Drivers  ---&gt;
   &lt;*&gt; Memory Technology Device (MTD) support  ---&gt;
       Self-contained MTD device drivers  ---&gt;
         &lt;*&gt; Support most SPI Flash chips (AT26DF, M25P, W25X, ...)
</pre></div>
</div>
<p class="rubric" id="readingwriting-to-flash">Reading/Writing to Flash</p>
<p><strong>Determine SPI NOR Partition MTD Identifier</strong></p>
<p>Within the kernel figuring out the mtd device number that is for a
particular SPI NOR partition is simple. A user simply needs to view the
list of mtd devices along with its name. Below command will provide this
information:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>cat /proc/mtd
</pre></div>
</div>
<p>An example of this output performed on the AM571x IDK EVM can be seen below.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>dev:    size   erasesize  name
mtd0: 00040000 00010000 &quot;QSPI.SPL&quot;
mtd1: 00100000 00010000 &quot;QSPI.u-boot&quot;
mtd2: 00080000 00010000 &quot;QSPI.u-boot-spl-os&quot;
mtd3: 00010000 00010000 &quot;QSPI.u-boot-env&quot;
mtd4: 00010000 00010000 &quot;QSPI.u-boot-env.backup1&quot;
mtd5: 00800000 00010000 &quot;QSPI.kernel&quot;
mtd6: 01620000 00010000 &quot;QSPI.file-system&quot;
</pre></div>
</div>
<p>Note the names of these partitions, their sizes (in hex) and offsets (in
hex) are determined within the specific board’s device tree file.</p>
<p><strong>Erasing</strong></p>
<p>Erasing a NOR partition can be performed by using the below command:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>flash_erase /dev/mtdX 0 0
</pre></div>
</div>
<p>Where X is the partition number.</p>
<p><strong>Reading/Writing</strong></p>
<p>Use the MTD interface provided for SPI flash on the EVM to validate
the SPI driver interface.</p>
<p>The below step copies 8KiB from /dev/mtd2 partition (u-boot env) to
/dev/mtd4 partition and reads the 8KiB image from /dev/mtd4 to a file
and checks the md5sum. The md5sum of test.img and test1.img should be same.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>cd /tmp
dd if=/dev/mtd2 of=test.img bs=8k count=1
md5sum test.img
flash_eraseall /dev/mtd4
dd if=test.img of=/dev/mtd4 bs=8k count=1
dd if=/dev/mtd4 of=test1.img bs=8k count=1
md5sum test1.img
</pre></div>
</div>
<p class="rubric" id="linux-userspace-interface">Linux Userspace Interface</p>
<p>In situations where a premade SPI driver doesn’t exist or a user wants a
simple means to send and receive SPI messages the spidev driver can be
used. Spidev provides a user space accessible means to communicate with
the SPI interface. Latest documentation regarding spidev driver can be
found
<a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/spi/spidev">here</a>.</p>
<p>Spidev allows users to interact with the spi interface in a variety of
programming languages that can communicate with kernel ioctls.</p>
<p class="rubric" id="kernel-configuration-2">Kernel Configuration</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Device Drivers  ---&gt;
   [*] SPI support
      &lt;*&gt; User mode SPI device driver support
</pre></div>
</div>
<p class="rubric">Device Tree</p>
<p>Below is an example of the device tree settings a user would use to
enable the spidev driver. Like most drivers for a peripheral, the spidev
driver is listed as a subnode of the main SPI peripheral driver.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>&amp;spi1 {
        status = &quot;okay&quot;;
        pinctrl-names = &quot;default&quot;;
        pinctrl-0 = &lt;&amp;spi1_pins_s0&gt;;
        spidev@1 {
                spi-max-frequency = &lt;24000000&gt;;
                reg = &lt;0&gt;;
                compatible = &quot;rohm,dh2228fv&quot;;
        };
};
</pre></div>
</div>
<ul class="simple">
<li>Note that reg property for SPI subnodes are usually used to indicate
the chip select to use when communicating with a particular driver.</li>
</ul>
<p class="rubric" id="test-application">Test Application</p>
<p>In the kernel sources,
./tools/spi/<a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/spi/spidev_test.c">spidev_test.c</a>
is a test application within the kernel that can be cross compiled to
show a C application interacting with the SPI peripheral.</p>
<p class="rubric">McSPI Master Slave Loopback</p>
<p>In the Jacinto family of devices  MAIN_MCSPI4 instance is internally
connected as slave to MCU_MCSPI2 master, a reference overlay is provided
to demonstrate the MCSPI internal loopback for J7200, for other platforms
the same overlay can be used with minor modifications to update for the PSIL
thread id.Run the following commands in u-boot console to load the overlays:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; setenv name_overlays k3-j7200-mcspi-loopback.dtbo
=&gt; boot
</pre></div>
</div>
<p>This will instantiate MAIN_MCSPI4 instance in slave mode and a spidev device
on MCU_MCSPI2 master thus helping to test the loopback behavior from userspace.
Note that the SPI Slave in Linux doesn’t implement flow-control by default and
custom flow control mechanism need to be implemented according to the application
for deterministic performance.</p>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Storage/NAND.html" class="btn btn-neutral float-right" title="3.2.2.18. NAND" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="SERDES/SERDES.html" class="btn btn-neutral" title="3.2.2.16. SERDES" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
      <a href="http://www.ti.com/corp/docs/legal/copyright.shtml">&copy; Copyright 1995-2021</a>, Texas Instruments Incorporated. All rights reserved. <br>
      <a href="http://www.ti.com/corp/docs/legal/trademark/trademrk.htm">Trademarks</a> | <a href="http://www.ti.com/corp/docs/legal/privacy.shtml">Privacy policy</a> | <a href="http://www.ti.com/corp/docs/legal/termsofuse.shtml">Terms of use</a> | <a href="http://www.ti.com/lsds/ti/legal/termsofsale.page">Terms of sale</a>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'08_06_00',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
        });

      var menuHeight = window.innerHeight;

      var contentOffset = $(".wy-nav-content-wrap").offset();
      var contentHeight = $(".wy-nav-content-wrap").height();
      var contentBottom = contentOffset.top + contentHeight;

      function setNavbarTop() {
          var scrollTop = $(window).scrollTop();
          var maxTop = scrollTop + menuHeight;

          // If past the header
          if (scrollTop > contentOffset.top && maxTop < contentBottom) {
            stickyTop = scrollTop - contentOffset.top;
          } else if (maxTop > contentBottom) {
            stickyTop = scrollTop - contentOffset.top - (maxTop - contentBottom);
          } else {
            stickyTop = 0;
          }

          $(".wy-nav-side").css("top", stickyTop);
      }

      $(document).ready(function() {
        setNavbarTop();
        $(window).scroll(function () {
          setNavbarTop();
        });
      });
  </script>
   

</body>
</html>